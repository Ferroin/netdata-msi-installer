<?xml version="1.0" encoding="utf-8"?>
<!--
    # This comment is generated by WixEdit, the specific commandline
    # arguments for the WiX Toolset are stored here.

    candleArgs: 
    lightArgs: "<projectname>.wixobj" -spdb -out "../<projectname>.msi" <extensions>
-->
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
    <Product Id="DE35032B-37F6-4AEC-AADD-B780E0638099" Name="NetdataWSL" Language="1033" Version="0.0.0.1" Manufacturer="Netdata" UpgradeCode="88BEA154-5510-4F79-9282-C3CE10760E2C">
        <Package Description="Netdata WSL agent" Comments="Simple test" InstallerVersion="200" Compressed="yes" />
        <Media Id="1" Cabinet="simple.cab" EmbedCab="yes" />
        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="ProgramFilesFolder" Name="PFiles">
                <Directory Id="NETDATA" Name="Netdata">
                    <Component Id="MSIHELPER1.PS1" DiskId="1" Guid="96FD730D-AFA7-4C50-8433-00A986589061">
                        <File Id="MSIHELPER1.PS1" Name="MSIhelper1.ps1" Source="MSIhelper1.ps1" />
                    </Component>
                    <Component Id="MSIHELPER2.CMD" DiskId="1" Guid="C51885C6-C2B3-4B00-94AB-14992AB0F59D">
                        <File Id="MSIHELPER2.CMD" Name="MSIhelper2.cmd" Source="MSIhelper2.cmd" />
                    </Component>
                    <Component Id="NETDATA.TAR" DiskId="1" Guid="F31E43CB-3844-4E6C-95EE-0DB7ACDB810A">
                        <File Id="NETDATA.TAR" Name="netdata.tar" Source="netdata.tar" />
                    </Component>
                </Directory>
            </Directory>
        </Directory>
        <Feature Id="DefaultFeature" Title="Main Feature" Level="1">
            <ComponentRef Id="MSIHELPER1.PS1" />
            <ComponentRef Id="MSIHELPER2.CMD" />
            <ComponentRef Id="NETDATA.TAR" />
        </Feature>
        <UI />
        <Property Id="TOKEN">0</Property>
        <Property Id="ROOMS">0</Property>
        <Property Id="URL">https://api.netdata.cloud</Property>
        <Property Id="TELEMETRY">1</Property>
        <CustomAction Id="RunStartScript0" Directory="NETDATA" ExeCommand="powershell.exe -ExecutionPolicy Bypass -NoProfile -File MSIhelper1.ps1" Execute="deferred" Return="check" Impersonate="no" />
        <CustomAction Id="RunStartScript1" Directory="NETDATA" ExeCommand="powershell.exe -c &quot;Remove-NetFirewallRule -DisplayName netdata&quot;" Execute="deferred" Return="ignore" Impersonate="no" />
        <CustomAction Id="RunStartScript1_1" Directory="NETDATA" ExeCommand="powershell.exe -c &quot;New-NetFirewallRule -Program C:\NetdataWSL\rootfs\usr\sbin\netdata -Action Allow -Profile Domain,Private,Public -DisplayName netdata -Description netdata -Direction Inbound&quot;" Execute="deferred" Return="ignore" Impersonate="no" />
        <CustomAction Id="RunStartScript2" Directory="NETDATA" ExeCommand="cmd.exe /c MSIhelper2.cmd [TOKEN] [ROOMS] [URL] [TELEMETRY]" Execute="deferred" Return="ignore" Impersonate="yes" />
        <CustomAction Id="RunStartScript5" Directory="NETDATA" ExeCommand="powershell.exe -c &quot;New-ItemProperty -Path HKCU:\Software\Microsoft\Windows\CurrentVersion\Run -Name Netdata -Value 'wsl.exe -d Netdata netdata'&quot;" Execute="deferred" Return="ignore" Impersonate="yes" />
        <CustomAction Id="RunStartScript6" Directory="NETDATA" ExeCommand="cmd.exe /c &quot;del netdata.tar &amp; del MSIhelper1.ps1 &amp; del MSIhelper2.cmd&quot;" Execute="deferred" Return="ignore" Impersonate="no" />
        <CustomAction Id="RunUninstScript" Directory="NETDATA" ExeCommand="cmd.exe /c wsl --unregister netdata" Execute="deferred" Return="ignore" Impersonate="yes" />
        <InstallExecuteSequence>
            <Custom Action="RunStartScript0" Before="InstallFinalize">NOT Installed</Custom>
            <Custom Action="RunStartScript1" After="RunStartScript0">NOT Installed</Custom>
            <Custom Action="RunStartScript1_1" After="RunStartScript1">NOT Installed</Custom>
            <Custom Action="RunStartScript2" After="RunStartScript1_1">NOT Installed</Custom>
            <Custom Action="RunStartScript5" After="RunStartScript1_1">NOT Installed</Custom>
            <Custom Action="RunStartScript6" After="RunStartScript5">NOT Installed</Custom>
            <Custom Action="RunUninstScript" After="InstallInitialize">Installed AND (NOT UPGRADINGPRODUCTCODE) AND (REMOVE="ALL")</Custom>
        </InstallExecuteSequence>
    </Product>
</Wix>